rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user is an admin, checking for existence.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the request is authenticated and the user ID matches the requested ID.
     * @param {string} userId - The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     * @param {string} userId - The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
    }

    /**
     * @description Rules for the /components/{componentId} collection.
     * @path /components/{componentId}
     * @allow (create) Signed-in user can create a component (admins in the future).
     * @deny (create) Non-signed-in user cannot create a component.
     * @allow (get) Any user can read a component.
     */
    match /components/{componentId} {
      // Anyone can read components
      allow get: if true;
      allow list: if true;

      // Only admins can create, update, or delete components
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /stores/{storeId} collection.
     * @path /stores/{storeId}
     * @allow (create) Signed-in user can create a store (admins in the future).
     * @deny (create) Non-signed-in user cannot create a store.
     * @allow (get) Any user can read a store.
     */
    match /stores/{storeId} {
      // Anyone can read stores
      allow get: if true;
      allow list: if true;

      // Only admins can create, update, or delete stores
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /categories/{categoryId} collection.
     * @path /categories/{categoryId}
     * @allow (create) Signed-in user can create a category (admins in the future).
     * @deny (create) Non-signed-in user cannot create a category.
     */
    match /categories/{categoryId} {
      // Anyone can read categories
      allow get: if true;
      allow list: if true;

      // Only admins can create, update, or delete categories
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /brands/{brandId} collection.
     * @path /brands/{brandId}
     * @allow (create) Signed-in user can create a brand (admins in the future).
     * @deny (create) Non-signed-in user cannot create a brand.
     */
    match /brands/{brandId} {
      // Anyone can read brands
      allow get: if true;
      allow list: if true;

      // Only admins can create, update, or delete brands
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /prices/{priceId} collection.
     * @path /prices/{priceId}
     * @allow (create) Signed-in user can create a price (admins in the future).
     * @deny (create) Non-signed-in user cannot create a price.
     */
    match /prices/{priceId} {
      // Anyone can read prices
      allow get: if true;
      allow list: if true;

      // Only admins can create, update, or delete prices
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     * @allow (create) Only the user themselves can create their admin role.
     * @deny (create) Non-signed-in user cannot create an admin role.
     * @allow (get) Only the user themselves can get their admin role.
     * @deny (update) Nobody can update an admin role doc.
     * @deny (delete) Only admins can delete an admin role document.
     */
    match /roles_admin/{userId} {
      // Only the user can create their admin role
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);

      // Only admins can delete an admin role document
      allow delete: if isAdmin();

      // No updates allowed
      allow update: if false;
      allow list: if false;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) Signed-in user can create their own user document.
     * @deny (create) Non-signed-in user cannot create a user document.
     */
    match /users/{userId} {
      // Signed-in user can create their own user document
      allow create: if request.auth.uid == userId;

      // Only the user themselves can read their profile
      allow get: if isOwner(userId);

      // Only the user themselves can update their profile
      allow update: if isOwner(userId);

      // Only the user themselves can delete their profile
      allow delete: if isOwner(userId);

      // Disable listing of users for privacy
      allow list: if false;
    }
  }
}