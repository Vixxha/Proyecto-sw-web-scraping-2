/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and sales data,
 *              with superuser access to all sales data and restricted access to audit logs. Public
 *              read access is granted for products, but writes are restricted.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the owning user.
 * - /users/{userId}/sales/{saleId}: Sales records for a specific user, accessible only to that user.
 * - /products/{productId}: Publicly readable product information, write access is restricted.
 * - /sales/{saleId}: Global sales records, accessible only to superusers.
 * - /audit_logs/{auditLogId}: Audit logs, write access is denied for all users.
 *
 * Key Security Decisions:
 * - User profiles and associated sales data are strictly owned by the user.
 * - Superusers (defined via custom claims) can read all sales data.
 * - Products are publicly readable but only writeable under specific conditions (TODO).
 * - Audit logs are read-only.
 * - User listing is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * - Sales documents in the `/sales` collection will require denormalized `userId` field to be consistent with `/users/{userId}/sales/{saleId}`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile access. Only the user can read and write their own profile.
     * @path /users/{userId}
     * @allow (create, update, get, delete) - User 'testUser' with UID 'testUser' can create/update/get/delete their own profile.
     * @deny (create, update, get, delete) - User 'otherUser' with UID 'otherUser' cannot create/update/get/delete 'testUser's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Manages sales records for a specific user. Only the user can read and write their own sales records.
     * @path /users/{userId}/sales/{saleId}
     * @allow (create, update, get, delete) - User 'testUser' can create/update/get/delete sales records under their own profile.
     * @deny (create, update, get, delete) - User 'otherUser' cannot create/update/get/delete sales records under 'testUser's profile.
     * @principle Enforces document ownership for sales records nested under user profiles.
     */
    match /users/{userId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Manages product information. Products are publicly readable, but writes are restricted.
     * @path /products/{productId}
     * @allow get, list - Anyone can read product information.
     * @deny create, update, delete - No one can create, update, or delete products without specific authorization (TODO).
     * @principle Allows public read access to product data while restricting write access.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add logic to allow product creation/updates by authorized users/roles.
    }

    /**
     * @description Manages global sales records. Only superusers can read and write these records.
     * @path /sales/{saleId}
     * @allow get, list - Superusers can read all sales records.
     * @deny get, list - Regular users cannot list sales records.
     * @allow create, update, delete - Superusers can create, update and delete sales records.
     * @deny create, update, delete - Regular users cannot create, update or delete sales records.
     * @principle Restricts access to sales records to superusers only.
     */
    match /sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isSuperUser() {
        return isSignedIn() && request.auth.token.superuser == true;
      }

      allow get, list: if isSuperUser();
      allow create: if isSuperUser();
      allow update: if isSuperUser() && resource != null;
      allow delete: if isSuperUser() && resource != null;
    }

    /**
     * @description Manages audit logs. Audit logs are read-only and only listable by superusers.
     * @path /audit_logs/{auditLogId}
     * @allow get - Anyone can get specific audit log.
     * @allow list - Only superusers can list audit logs.
     * @deny create, update, delete - No one can create, update, or delete audit logs.
     * @principle Restricts write access to audit logs and limits listing to superusers.
     */
    match /audit_logs/{auditLogId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isSuperUser() {
          return isSignedIn() && request.auth.token.superuser == true;
        }

        allow get: if isSignedIn();
        allow list: if isSuperUser();
        allow create, update, delete: if false;
    }
  }
}