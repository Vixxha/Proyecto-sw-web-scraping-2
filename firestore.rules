/**
 * @file Firebase Security Rules for ComponentCompares Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and their associated sales records.
 *   Products are publicly readable, but only authorized users can create, update, or delete them. Audit logs are write-only,
 *   intended for server-side logging, and completely inaccessible to client reads. Superuser role isn't implemented yet, but
 *   is reserved for future authorization enhancements.
 *
 * @data_structure The data is organized hierarchically:
 *   - /users/{userId}: Stores user profiles, where {userId} matches the Firebase Auth UID.
 *   - /users/{userId}/sales/{saleId}: Stores sales records specific to a user.
 *   - /products/{productId}: Stores product information, publicly readable.
 *   - /sales/{saleId}: Stores all sales records.
 *   - /audit_logs/{auditLogId}: Stores audit logs.
 *
 * @key_security_decisions
 *   - User listing is disallowed to protect privacy.
 *   - Public read access to products is allowed to enable browsing without authentication.
 *   - Audit logs are write-only and cannot be read by any client, ensuring data integrity and preventing information leakage.
 *   - Superuser role is reserved for future authorization enhancements and isn't used in the current rules.
 *
 * @denormalization_for_authorization Not applicable in the current ruleset, but could be used in the future to enhance performance
 *   and security. For example, adding a `userId` field to the `Product` entity could simplify ownership checks.
 *
 * @structural_segregation Private user data is stored under the /users/{userId} path, while public product data is stored in the
 *   top-level /products collection. This segregation simplifies access control and improves performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth UID.
     * @allow (get, update, delete) - Authenticated user can only access their own profile if the userId matches their auth UID.
     * @deny (list) - Listing all users is not allowed.
     * @deny (create) - An unauthenticated user cannot create a profile
     * @deny (update, delete) - An authenticated user cannot modify or delete another user's profile
     * @principle Enforces document ownership, ensuring users can only manage their own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to sales records for a specific user.
     * @path /users/{userId}/sales/{saleId}
     * @allow (create, get, list, update, delete) - Authenticated user can only manage their own sales records.
     * @deny (create, get, list, update, delete) - An authenticated user cannot manage another user's sales records.
     * @principle Enforces document ownership within a user-specific subcollection.
     */
    match /users/{userId}/sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to product information.
     * @path /products/{productId}
     * @allow (get, list) - All users can read product information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete product information.
     * @principle Allows public read access while restricting write access to authorized users.
     */
    match /products/{productId} {
       function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // TODO: Add more restrictive role-based authorization.
      allow update: if isSignedIn(); // TODO: Add more restrictive role-based authorization.
      allow delete: if isSignedIn(); // TODO: Add more restrictive role-based authorization.
    }

     /**
     * @description Controls access to all sales records.
     * @path /sales/{saleId}
     * @deny (get, list, create, update, delete) - No client access is allowed.
     * @principle Restricts all client access to this collection.
     */
    match /sales/{saleId} {
       allow get: if false;
       allow list: if false;
       allow create: if false;
       allow update: if false;
       allow delete: if false;
    }

    /**
     * @description Controls access to audit logs.
     * @path /audit_logs/{auditLogId}
     * @deny (get, list, update, delete) - No client access is allowed.
     * @allow (create) - Only authenticated users can create audit logs.
     * @principle Restricts all read access to this collection and allows only authenticated users to create logs.
     */
    match /audit_logs/{auditLogId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn(); // TODO: Add more restrictive role-based authorization.
      allow update: if false;
      allow delete: if false;
    }
  }
}