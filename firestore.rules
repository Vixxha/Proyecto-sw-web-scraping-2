/**
 * @fileoverview Firestore Security Rules for ComponentCompares application.
 *
 * Core Philosophy:
 * This ruleset implements a hybrid security model, balancing open read access for products with strict owner-based and role-based access control for user data, sales, and audit logs. Superusers have elevated privileges for auditing purposes.
 *
 * Data Structure:
 * - /users/{userId}: Stores personal user data, secured with owner-only access.
 * - /users/{userId}/sales/{saleId}: Stores sales data for each user, accessible only by the user.
 * - /products/{productId}: Stores product information, publicly readable but writable only by superusers.
 * - /sales/{saleId}: Stores all sales data, readable and writable only by superusers for reporting and analysis.
 * - /audit_logs/{auditLogId}: Stores audit logs, writable only by the application itself (using server-side logic with appropriate service accounts) and readable only by superusers.
 *
 * Key Security Decisions:
 * - Public Read Access for Products: Allows anonymous users to browse product listings.
 * - Superuser Role: Grants elevated privileges to specific users for managing products, sales, and audit logs.
 * - Audit Log Protection: Restricts write access to audit logs to prevent tampering.
 * - Deny User Listing: Listing all users is disallowed for privacy reasons.
 * - Immutability of User IDs: Once a user document is created, the 'id' field (matching the auth UID) cannot be changed.
 *
 * Denormalization for Authorization:
 * - User Role: The `role` field is denormalized directly onto the `/users/{userId}` document. This allows the rules to quickly check for superuser status without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication is required for certain operations.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document, based on the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Prevents operations on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'superuser' role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Role-based access control.
     */
    function isSuperuser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser';
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) A user can create their own profile if the userId matches their auth UID.
     * @allow (get) A user can read their own profile.
     * @allow (update) A user can update their own profile.
     * @allow (delete) A user can delete their own profile.
     * @deny (create) A user cannot create a profile for another user (userId mismatch).
     * @deny (update) A user cannot update another user's profile.
     * @deny (delete) A user cannot delete another user's profile.
     * @principle Enforces user-ownership for profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing all users is disallowed for privacy reasons.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for sales records within a user's profile.
     * @path /users/{userId}/sales/{saleId}
     * @allow (create) A user can create a sale record under their profile.
     * @allow (get) A user can read a sale record under their profile.
     * @allow (update) A user can update a sale record under their profile.
     * @allow (delete) A user can delete a sale record under their profile.
     * @deny (create) A user cannot create a sale record under another user's profile.
     * @deny (update) A user cannot update a sale record under another user's profile.
     * @deny (delete) A user cannot delete a sale record under another user's profile.
     * @principle Enforces user-ownership for sales records.
     */
    match /users/{userId}/sales/{saleId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for product listings.
     * @path /products/{productId}
     * @allow (get) Anyone can read product listings.
     * @allow (list) Anyone can list product listings.
     * @allow (create) Only superusers can create product listings.
     * @allow (update) Only superusers can update product listings.
     * @allow (delete) Only superusers can delete product listings.
     * @deny (create) Regular users cannot create product listings.
     * @deny (update) Regular users cannot update product listings.
     * @deny (delete) Regular users cannot delete product listings.
     * @principle Public read access with superuser-only writes.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSuperuser();
      allow update: if isSuperuser() && resource != null;
      allow delete: if isSuperuser() && resource != null;
    }

    /**
     * @description Rules for global sales data (for superusers).
     * @path /sales/{saleId}
     * @allow (get) Only superusers can read global sales data.
     * @allow (list) Only superusers can list global sales data.
     * @allow (create) Only superusers can create global sales data.
     * @allow (update) Only superusers can update global sales data.
     * @allow (delete) Only superusers can delete global sales data.
     * @deny (create) Regular users cannot create global sales data.
     * @deny (update) Regular users cannot update global sales data.
     * @deny (delete) Regular users cannot delete global sales data.
     * @principle Superuser-only access for reporting and analysis.
     */
    match /sales/{saleId} {
      allow get: if isSuperuser();
      allow list: if isSuperuser();
      allow create: if isSuperuser();
      allow update: if isSuperuser() && resource != null;
      allow delete: if isSuperuser() && resource != null;
    }

    /**
     * @description Rules for audit logs.
     * @path /audit_logs/{auditLogId}
     * @allow (get) Only superusers can read audit logs.
     * @allow (list) Only superusers can list audit logs.
     * @allow (create) Only the application itself (using a service account) can create audit logs.
     * @deny (create) Regular users cannot create audit logs.
     * @deny (update) No one can update audit logs (immutable).
     * @deny (delete) No one can delete audit logs.
     * @principle Restricts write access to audit logs to prevent tampering.
     */
    match /audit_logs/{auditLogId} {
      allow get: if isSuperuser();
      allow list: if isSuperuser();
      allow create: if false; // TODO: Implement service account authentication for audit log creation.  For prototyping, this is denied.
      allow update: if false;
      allow delete: if false;
    }
  }
}