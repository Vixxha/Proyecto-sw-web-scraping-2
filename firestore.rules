/**
 * @file Firebase Security Rules for ComponentCompares Application
 *
 * @core_philosophy This ruleset enforces a role-based access control model with user-level ownership for personal data and elevated privileges for 'superuser' roles.
 *
 * @data_structure The Firestore database is structured with user profiles stored under `/users/{userId}`, products under `/products/{productId}`, and sales data organized both under individual users (`/users/{userId}/sales/{saleId}`) and globally in `/sales/{saleId}` for superuser access. Audit logs are stored under `/audit_logs/{auditLogId}`.
 *
 * @key_security_decisions
 *   - Superusers can read and write all data, including user profiles, products, sales, and audit logs.
 *   - Regular users have full access only to their own profile data and sales records.
 *   - Listing of all users is disallowed to prevent unauthorized data access.
 *   - Public read access is not granted to any collection.
 *
 * @denormalization_for_authorization The `User` entity includes a `role` field, which is used to quickly determine if a user has 'superuser' privileges.  Sales documents include `userId` which allows rules to quickly authorize access to user-specific sales records.
 *
 * @structural_segregation User sales data is stored in user-specific subcollections and in a global sales collection, allowing for both user-level access control and superuser-level oversight.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile access. Users can only access their own profile data, while superusers can access all profiles.
     * @path /users/{userId}
     * @allow (get, update, delete) User 'user_abc' with role 'user' can get, update and delete the profile with id 'user_abc'.
     * @allow (get, create, update, delete) User 'super_user' with role 'superuser' can get, create, update and delete any user profile.
     * @deny (get, update, delete) User 'user_abc' cannot access the profile with id 'user_xyz'.
     * @deny (list) Listing all users is not allowed.
     * @principle Enforces user-ownership and role-based access for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isSuperuser());
      allow list: if false; // Listing all users is disallowed
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && (isOwner(userId) || isSuperuser());
      allow delete: if isSignedIn() && (isOwner(userId) || isSuperuser());
    }

    /**
     * @description Manages sales records for individual users.  Users can only access their own sales records, while superusers can access all sales records.
     * @path /users/{userId}/sales/{saleId}
     * @allow (get, create, update, delete) User 'user_abc' can get, create, update and delete their own sales record.
     * @allow (get, create, update, delete) User 'super_user' can get, create, update and delete any user's sales record.
     * @deny (get, create, update, delete) User 'user_abc' cannot access sales records of another user.
     * @principle Enforces user-ownership and role-based access for user-specific sales records.
     */
    match /users/{userId}/sales/{saleId} {
      allow get: if isSignedIn() && (isOwner(userId) || isSuperuser());
      allow list: if isSignedIn() && (isOwner(userId) || isSuperuser());
      allow create: if isSignedIn() && (request.resource.data.userId == userId) && (isOwner(userId) || isSuperuser());
      allow update: if isSignedIn() && ((resource.data.userId == userId && isOwner(userId)) || isSuperuser());
      allow delete: if isSignedIn() && ((resource.data.userId == userId && isOwner(userId)) || isSuperuser());
    }

    /**
     * @description Manages access to product information. Superusers can create, update, and delete products. All users can read product information.
     * @path /products/{productId}
     * @allow (get, list) Any signed-in user can read product information.
     * @allow (create, update, delete) Only superusers can create, update, and delete products.
     * @deny (create, update, delete) Regular users cannot create, update, or delete products.
     * @principle Enforces role-based access for product management.
     */
    match /products/{productId} {
      allow get: if isSignedIn() || true; //Public Read.
      allow list: if isSignedIn() || true; //Public Read.
      allow create: if isSignedIn() && isSuperuser();
      allow update: if isSignedIn() && isSuperuser();
      allow delete: if isSignedIn() && isSuperuser();
    }

    /**
     * @description Provides a global collection of sales data, accessible only to superusers.
     * @path /sales/{saleId}
     * @allow (get, list, create, update, delete) Only superusers can access and manage sales data in this collection.
     * @deny (get, list, create, update, delete) Regular users cannot access this collection.
     * @principle Restricts access to sensitive sales data to authorized personnel only.
     */
    match /sales/{saleId} {
      allow get: if isSignedIn() && isSuperuser();
      allow list: if isSignedIn() && isSuperuser();
      allow create: if isSignedIn() && isSuperuser();
      allow update: if isSignedIn() && isSuperuser();
      allow delete: if isSignedIn() && isSuperuser();
    }

    /**
     * @description Manages access to audit logs. Only superusers can read and write audit logs.
     * @path /audit_logs/{auditLogId}
     * @allow (get, list, create, update, delete) Only superusers can create, read, update, and delete audit logs.
     * @deny (get, list, create, update, delete) Regular users cannot access audit logs.
     * @principle Enforces strict access control for audit logs to maintain data integrity and security.
     */
    match /audit_logs/{auditLogId} {
      allow get: if isSignedIn() && isSuperuser();
      allow list: if isSignedIn() && isSuperuser();
      allow create: if isSignedIn() && isSuperuser();
      allow update: if isSignedIn() && isSuperuser();
      allow delete: if isSignedIn() && isSuperuser();
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isSuperuser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser';
    }
  }
}