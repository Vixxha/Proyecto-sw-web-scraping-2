rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile at /users/user123.
     * @allow (get) User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) User with UID 'user456' cannot create a profile at /users/user123.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to sales records for a specific user.
     * @path /users/{userId}/sales/{saleId}
     * @allow (create) User with UID 'user123' can create a sale record under their profile.
     * @allow (get) User with UID 'user123' can read a sale record under their profile.
     * @allow (update) User with UID 'user123' can update a sale record under their profile.
     * @allow (delete) User with UID 'user123' can delete a sale record under their profile.
     * @deny (create) User with UID 'user456' cannot create a sale record under /users/user123.
     * @principle Enforces document ownership for all operations on sales records within a user's profile.
     */
    match /users/{userId}/sales/{saleId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to product documents.
     * @path /products/{productId}
     * @allow (get) Any user can read product information.
     * @allow (list) Any user can list product information.
     * @deny (create) No user can create a product without specific authorization.
     * @deny (update) No user can update a product without specific authorization.
     * @deny (delete) No user can delete a product without specific authorization.
     * @principle Allows public read access to products.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add authorization for creating products (e.g., admin role).
      allow update: if false; // TODO: Add authorization for updating products (e.g., admin role).
      allow delete: if false; // TODO: Add authorization for deleting products (e.g., admin role).
    }

    /**
     * @description Controls access to the global sales collection.
     * @path /sales/{saleId}
     * @allow (get) Only superusers can read individual sales records.
     * @allow (list) Only superusers can list all sales records.
     * @deny (create) No user can create a global sale directly.
     * @deny (update) No user can update a sale without specific authorization.
     * @deny (delete) No user can delete a sale without specific authorization.
     * @principle Restricts access to global sales data to superusers.
     */
    match /sales/{saleId} {
      function isSuperuser() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser';
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isSuperuser();
      allow list: if isSignedIn() && isSuperuser();
      allow create: if false; // Sales are created via the user subcollection.
      allow update: if false; // TODO: Add authorization for updating sales (e.g., admin role).
      allow delete: if false; // TODO: Add authorization for deleting sales (e.g., admin role).
    }

    /**
     * @description Controls access to audit log documents.
     * @path /audit_logs/{auditLogId}
     * @allow (get) Only superusers can read audit log entries.
     * @allow (list) Only superusers can list audit log entries.
     * @deny (create) No user can create an audit log entry without specific authorization.
     * @deny (update) No user can update an audit log entry without specific authorization.
     * @deny (delete) No user can delete an audit log entry without specific authorization.
     * @principle Restricts access to audit logs to superusers.
     */
    match /audit_logs/{auditLogId} {
      function isSuperuser() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser';
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isSuperuser();
      allow list: if isSignedIn() && isSuperuser();
      allow create: if false; // TODO: Add authorization for creating audit logs (e.g., a service account).
      allow update: if false; // TODO: Add authorization for updating audit logs (e.g., a service account).
      allow delete: if false; // TODO: Add authorization for deleting audit logs (e.g., a service account).
    }
  }
}